# 后端开发规约 (Backend Coding Standards) v2.0

> **核心原则**: 阿里规约底层、若依架构中层、AI 协作顶层。
> **定位**: 所有 AI 编码与代码审查的最高红线。

---

## 🛑 核心红线 (必须遵守)

### 1. 分层架构
- ✅ 严格遵守 `Controller → Service → Mapper` 三层架构。
- ❌ **禁止跨层**: Controller 禁止直接调用 Mapper，Service 必须包含业务逻辑。
- ❌ **禁止循环依赖**: 发现循环依赖必须通过引入中转 Service 或重构解耦。

### 2. 并发与内存安全 (Alibaba 精华)
- ❌ **禁止手动创建线程**: 必须通过已定义的 `ThreadPoolTaskExecutor` 获取线程，防止资源耗尽。
- ✅ **ThreadLocal 安全**: 使用 `ThreadLocal` 变量必须在 `finally` 块中显式执行 `remove()`，防止内存泄漏。
- ✅ **集合初始化**: 初始化集合时必须指定初始容量 `new HashMap<>(16)`，减少扩容开销。

### 3. 数值精度与类型 (稳定性)
- ❌ **禁止使用 float/double 表示货币**: 涉及高精度计算、测点阈值、金额时，必须使用 **`BigDecimal`**。
- ✅ **BigDecimal 比较**: 必须使用 `compareTo()`，禁止使用 `equals()`。
- ✅ **枚举使用**: 状态字段必须定义枚举或常量类，禁止在代码中硬编码 "Magic Number"。

### 4. SQL 极致性能 (DB 红线)
- ❌ **禁止 SELECT ***: 必须按需指定字段，减少 IO 与网络开销。
- ❌ **循环查询**: 严禁在 `for` 循环内执行数据库查询。必须使用 `IN` 查询或批量 Join。
- ✅ **分页必限**: 所有分页查询接口必须设置默认最大 Limit (推荐 500)，保护数据库。
- ✅ **Upsert 策略**: 导入或同步数据时，优先使用 `saveOrUpdate` (基于唯一编码)。

### 5. 异常与日志
- ✅ **业务异常**: 必须抛出 `ServiceException`。日志必须包含上下文参数（全中文描述）。
- ✅ **堆栈保护**: `log.error` 必须带上 e ( `log.error("context", e)` )。
- ✅ **Jackson 唯一性**: 全局使用 Jackson，禁止引入 Fastjson 导致序列化冲突。

### 6. 注释与 AI 协作
- ✅ **ADR 登记**: 重大重构、Solid Asset 触碰或新增算子组件必须在 `Sentinel-K_内核/03_决策日志 (ADR).md` 登记 (遵循 `[K-ADR]`)。
- ✅ **反向证明**: 核心逻辑变更必须提供 `Reverse_Proof` 证据 (遵循 `[K-TEST]`)。
- ✅ **切片意识**: 任务规模触发 `[K-PIZZA]` 阈值 (3文件/100行) 时必须主动申请切片。

---

## 🏗️ 代码示例 (快速参考)

### A. BigDecimal 计算
```java
// ✅ 正确：使用字符串构造并使用 compareTo
BigDecimal val = new BigDecimal("0.1");
if (other.compareTo(val) > 0) { ... }
```

### B. 线程池使用 (RuoYi)
```java
// ✅ 正确：注入已有线程池
@Autowired
@Qualifier("threadPoolTaskExecutor")
private ThreadPoolTaskExecutor executor;
```

---

## 📂 包结构规定 (Sentinel-K 专用)
- `com.zhendong.sentinel.core`: 核心引擎、算法编排逻辑。
- `com.zhendong.sentinel.mapper`: 数据库持久层。
- `com.zhendong.sentinel.service.strategy`: 不同存储引擎的策略实现类。


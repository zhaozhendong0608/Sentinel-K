# 为什么你的 AI 写代码总是“很多幻觉”？因为你不懂核心的“切披萨法则” (Pizza Logic)

> **副标**：别再让 AI 一次性“吞”下整个需求了。教你用 Sentinel-K 意图驱动，把任务像切披萨一样拆解，从此 0 Bug 交付。

---

## 1. 痛苦的真相：AI 不是神，是概率机器

很多开发者都有过这样的崩溃时刻：
> 你：“帮我写一个订单创建服务，包含库存扣减、优惠券核销、积分累积和异步通知。”
> AI：“没问题，这是代码...” (哗啦啦输出了 500 行 Java 代码)
> 你：“跑一下测试。”
> AI：“抱歉，这里有个 NPE... 抱歉，那个库我引错了... 抱歉，逻辑好像反了...”

你以为 AI 是全知全能的超级工程师，其实它只是一个**概率预测模型**。当上下文长度超过一定阈值（比如 200 行复杂逻辑），AI 的注意力机制就会发散，开始一本正经地胡说八道——这就是**幻觉 (Hallucination)**。

**结论**：试图用一个 Prompt 让 AI 写完一个复杂系统，注定会失败。

## 2. 什么是“切披萨法则” (Pizza Logic)？

在 **Sentinel-K 开发规约** 中，为了对抗这种概率性失效，我们引入了一条硬核法则：**切披萨法则 (Pizza Logic)**。

### 核心定义 `[K-PIZZA]`
当一个开发任务（Intent）满足以下任一条件时，**严禁**直接让 AI 开始写业务逻辑：
1.  **变更范围** > 3 个文件
2.  **代码行数** > 100 行（预估）
3.  **逻辑复杂度**：涉及跨模块调用或核心事务。

### 动作：强制拆分
必须将任务像切披萨一样，物理拆解为 3 个原子阶段 (Sub-Intents)：

*   **Stage A (Bone / 骨架)**：
    *   **指令**：“只定义接口 (Interface)、DTO 结构和异常标识，**严禁实现任何业务逻辑**。”
    *   **产物**：只有方法签名和类结构。
    *   **通过标准**：编译通过。

*   **Stage B (Stub / 桩)**：
    *   **指令**：“实现所有接口的 Mock 返回，编写并跑通端到端测试。”
    *   **产物**：能跑通的“空壳”应用。
    *   **通过标准**：测试全绿 (Green)，链路打通。

*   **Stage C (Muscle / 肌肉)**：
    *   **指令**：“现在填充 `Service` 层的具体业务逻辑。每次只实现一个核心方法。”
    *   **产物**：真实业务代码。
    *   **通过标准**：反向测试 (Reverse Testing) 通过。

## 3. 为什么要这么切？

### 3.1 降低上下文负载
*   **不切**：AI 需要同时考虑“接口怎么定义”、“数据怎么流转”、“异常怎么捕获”、“算法怎么写”。CPU 过载，必出幻觉。
*   **切了**：AI 在 Stage A 只考虑“结构”，在 Stage C 只考虑“算法”。**专注力提升 10 倍**。

### 3.2 物理隔离风险
*   **不切**：写到第 400 行出错了，你根本不敢动，因为不知道改了这里会不会崩了那里。
*   **切了**：Stage A 错了？重写接口又不花钱。Stage C 错了？反正接口是稳的，只改实现就好。

### 3.3 意图对齐
指挥官（你）可以在 Stage A 阶段就发现：“哎，这个 DTO 设计得不对，少了个字段”。这时候修改成本极低。如果等 AI 写完 500 行代码你才发现少了个字段，那就等着“牵一发而动全身”的重构地狱吧。

## 4. 实战演示：10 分钟 0 Bug 开发

### ❌ 错误示范 (一波流)
> **Prompt**: “写一个带有分布式锁的库存扣减服务。”
> **Result**: AI 写了一堆代码，锁的 key 没加前缀，finally 块忘了释放锁，异常处理也乱七八糟。

### ✅ 正确示范 (Sentinel-K Pizza Mode)

#### 第一刀：Stage A (Bone)
> **Prompt**: “执行 Pizza Logic。阶段 A：请定义 `InventoryService` 接口和 `InventoryDTO`。要求：包含 `deduct` 方法，抛出 `InsufficientStockException`。**不要写实现**。”
> **AI**: 输出清晰的 Interface 和 DTO。
> **你**: “ACK。接口设计合理。”

#### 第二刀：Stage C (Muscle) - 分片 1
> **Prompt**: “阶段 C-1：仅实现 `deduct` 方法的**分布式锁获取逻辑**。使用 Redisson，锁等待 3秒，超时抛异常。”
> **AI**: 专注写锁逻辑，代码极其标准，finally 块完美。

#### 第三刀：Stage C (Muscle) - 分片 2
> **Prompt**: “阶段 C-2：在锁内部实现数据库扣减逻辑。若库存不足抛出异常。”
> **AI**: 专注写 SQL 和判断逻辑。

**结果**：你得到了一个逻辑严密、异常处理完善、无幻觉的工业级服务。

---

## 5. 结语

**AI 时代不需要“提示词工程师”，需要的是“懂切披萨的指挥官”。**

不要妄想 AI 能一次性给你一个完美的系统。做一个冷静的指挥官，举起你的“披萨刀”，把复杂的需求拆解成 AI 能消化的小块。

这，就是 **Sentinel-K** 开发规约的核心心法之一。

> **下期预告**：《你的 AI 代码虽然绿灯了，但它是对的吗？——反向测试 (Reverse Testing) 的暴力美学》
